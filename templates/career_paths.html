{% extends "base.html" %}

{% block title %}Career Path Recommendations{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Personalized Career Path Recommendations</h1>
            
            {% if not has_skill_data %}
            <div class="alert alert-warning">
                <h4>Complete a Skills Assessment First</h4>
                <p>To receive personalized career path recommendations, please complete at least one skills assessment.</p>
                <a href="/skill_assessment" class="btn btn-primary">Take Skills Assessment</a>
            </div>
            {% elif not recommendations %}
            <div class="alert alert-info">
                <p>Generate personalized career path recommendations based on your skills and assessment results.</p>
                <button id="generate-recommendations" class="btn btn-primary">Generate Recommendations</button>
                <div id="loading-indicator" class="mt-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Analyzing your skills profile... This may take a moment.</span>
                </div>
            </div>
            {% else %}
            <div class="mb-4">
                <p>Based on your skills profile and assessment results, here are your personalized career path recommendations:</p>
                <button id="refresh-recommendations" class="btn btn-outline-primary">Refresh Recommendations</button>
                <div id="loading-indicator" class="mt-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Updating your recommendations...</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    {% if recommendations %}
    <div class="row" id="recommendations-container">
        {% for rec in recommendations %}
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ rec.title }}</h5>
                    <span class="badge rounded-pill bg-primary">{{ rec.matching_score }}% Match</span>
                </div>
                <div class="card-body">
                    <p>{{ rec.description }}</p>
                    <div class="mb-3">
                        <h6>Required Skills:</h6>
                        <p class="mb-1">
                            {% for skill in rec.required_skills.split(',') %}
                            <span class="badge bg-light text-dark me-1">{{ skill.strip() }}</span>
                            {% endfor %}
                        </p>
                    </div>
                    <div class="mb-3">
                        <h6>Growth Potential:</h6>
                        <p>{{ rec.growth_potential }}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Market Demand:</h6>
                        <p>{{ rec.market_demand }}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Average Salary:</h6>
                        <p>{{ rec.avg_salary }}</p>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-sm btn-outline-primary view-details" data-path-id="{{ rec.career_path_id }}">View Details</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Career Path Detail Modal -->
    <div class="modal fade" id="careerPathModal" tabindex="-1" aria-labelledby="careerPathModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="careerPathModalLabel">Career Path Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="career-path-details">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Generate recommendations button
    const generateBtn = document.getElementById('generate-recommendations');
    if (generateBtn) {
        generateBtn.addEventListener('click', generateRecommendations);
    }
    
    // Refresh recommendations button
    const refreshBtn = document.getElementById('refresh-recommendations');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', generateRecommendations);
    }
    
    // View details buttons
    const viewDetailsBtns = document.querySelectorAll('.view-details');
    viewDetailsBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const pathId = this.getAttribute('data-path-id');
            openCareerPathDetails(pathId);
        });
    });
    
    // Function to generate recommendations
    function generateRecommendations() {
        // Show loading indicator
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.classList.remove('d-none');
        
        // Disable the button
        this.disabled = true;
        
        // Make API request
        fetch('/api/generate_career_recommendations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the page to show new recommendations
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to generate recommendations'));
                loadingIndicator.classList.add('d-none');
                this.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
            loadingIndicator.classList.add('d-none');
            this.disabled = false;
        });
    }
    
    // Function to open career path details modal
    function openCareerPathDetails(pathId) {
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('careerPathModal'));
        modal.show();
        
        // Reset modal content
        document.getElementById('career-path-details').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>`;
        
        // Fetch career path details
        fetch(`/api/career_path_details/${pathId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('career-path-details').innerHTML = `
                    <div class="alert alert-danger">
                        ${data.error}
                    </div>`;
                    return;
                }
                
                // Update modal title
                document.getElementById('careerPathModalLabel').textContent = data.title;
                
                // Format skills as badges
                const skills = data.required_skills.split(',').map(skill => 
                    `<span class="badge bg-light text-dark me-1">${skill.trim()}</span>`
                ).join('');
                
                // Format the recommendation date if available
                let matchingInfo = '';
                if (data.matching_score) {
                    const date = new Date(data.recommendation_date);
                    const formattedDate = date.toLocaleDateString();
                    matchingInfo = `
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Your matching score: ${data.matching_score}%</strong>
                            <small>Generated on ${formattedDate}</small>
                        </div>
                    </div>`;
                }
                
                // Update modal content
                document.getElementById('career-path-details').innerHTML = `
                    ${matchingInfo}
                    
                    <h5>Description</h5>
                    <p>${data.description}</p>
                    
                    <h5>Required Skills</h5>
                    <p>${skills}</p>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Growth Potential</h5>
                            <p>${data.growth_potential}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Market Demand</h5>
                            <p>${data.market_demand}</p>
                        </div>
                    </div>
                    
                    <h5>Average Salary</h5>
                    <p>${data.avg_salary}</p>
                    
                    <h5>Next Steps to Advance</h5>
                    <p>${data.next_steps}</p>
                    
                    <div class="mt-4">
                        <h5>Related Resources</h5>
                        <div class="card">
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Explore job listings for this role</span>
                                        <a href="/job_market_analysis?role=${encodeURIComponent(data.title)}" class="btn btn-sm btn-outline-primary">View Jobs</a>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Get resume tips for this career</span>
                                        <a href="/resume_tips" class="btn btn-sm btn-outline-primary">Resume Tips</a>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Assess your skills for this path</span>
                                        <a href="/skill_assessment" class="btn btn-sm btn-outline-primary">Skill Assessment</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('career-path-details').innerHTML = `
                <div class="alert alert-danger">
                    An error occurred while loading career path details. Please try again.
                </div>`;
            });
    }
});
</script>
{% endblock %}